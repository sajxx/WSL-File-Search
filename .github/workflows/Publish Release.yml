name: Publish Release

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore: 
      - .github/workflows/*
      - README.md
      - .gitignore

# Add this permissions block
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      python_ver: 3.8
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.python_ver }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.python_ver }}
          
      - name: Get version from plugin.json
        id: version
        uses: notiz-dev/github-action-json-property@release
        with: 
          path: 'plugin.json'
          prop_path: 'Version'
          
      - run: echo "Plugin version is ${{steps.version.outputs.prop}}"
      
      - name: Create requirements.txt if not exists
        run: |
          if [ ! -f requirements.txt ]; then
            echo "flowlauncher>=1.0.0" > requirements.txt
          fi
          
      - name: Install dependencies to lib directory
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -t ./lib
          
      - name: Clean up lib directory
        run: |
          find ./lib -name "*.pyc" -delete
          find ./lib -name "__pycache__" -type d -exec rm -rf {} +
          find ./lib -name "*.dist-info" -type d -exec rm -rf {} +
          
      - name: Create plugin package
        run: |
          mkdir -p "WSL File Search"
          cp -r . "WSL File Search/"
          cd "WSL File Search"
          rm -rf .git .github .gitignore requirements.txt
          cd ..
          zip -r "WSL File Search.zip" "WSL File Search/"
          
      - name: Publish Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: 'Flow.Launcher.Plugin.WSLSearch.zip'
          tag_name: "v${{steps.version.outputs.prop}}"
          body: |
            **WSL File Search Plugin v${{steps.version.outputs.prop}}**
            
            Search files inside WSL using fd with seamless Windows integration.
            
            **Features:**
            - ‚ö° Ultra-fast search using fd
            - üéØ Configurable result limits
            - üóÇÔ∏è Open files in Windows Explorer
            - ‚å®Ô∏è Terminal access via Windows Terminal
            - ‚öôÔ∏è User-friendly settings
            
            **Installation:**
            1. Download Flow.Launcher.Plugin.WSLSearch.zip
            2. Extract to: `%APPDATA%\FlowLauncher\Plugins\WSL File Search\`
            3. Restart Flow Launcher
            4. Use `wslf` keyword to search WSL files
            
            **Requirements:**
            - WSL 2 with Ubuntu/Debian
            - fd installed in WSL (`sudo apt install fd-find`)
            - Flow Launcher v1.20+
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}